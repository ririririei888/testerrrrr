<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì—ì–´í•˜í‚¤: ìŠ¤í‹± ìŠ¤ë§¤ì‹œ (Final Fix)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Pretendard', sans-serif; user-select: none; }
    canvas { touch-action: none; }
  </style>
</head>
<body class="m-0 p-0 overflow-hidden">
  <div class="min-h-screen bg-gradient-to-b from-gray-900 via-slate-900 to-black flex items-center justify-center p-4">
    <div class="max-w-5xl w-full">
      <!-- UI íŒ¨ë„ -->
      <div class="bg-black/60 backdrop-blur-lg rounded-2xl p-4 mb-4 shadow-2xl border border-white/10">
        <div class="flex justify-between items-center">
          <div class="text-center flex-1">
            <div class="text-red-500 font-bold tracking-widest text-sm">PLAYER 1</div>
            <div class="text-6xl font-black text-red-500 drop-shadow-[0_0_10px_rgba(239,68,68,0.5)]" id="score-p1">0</div>
            <div class="text-xs text-gray-400 mt-2">ì´ë™: WASD | ìŠ¤ìœ™: <span class="text-white font-bold">E (ì°¨ì§€)</span></div>
          </div>
          <div class="px-6 text-center">
            <!-- íƒ€ì´ë¨¸ -->
            <div id="timer" class="text-white text-5xl font-black font-mono tracking-tighter drop-shadow-lg">15</div>
            <div class="text-[10px] text-gray-500 mt-1 uppercase tracking-widest">Speed Boost Timer</div>
          </div>
          <div class="text-center flex-1">
            <div class="text-cyan-500 font-bold tracking-widest text-sm">PLAYER 2</div>
            <div class="text-6xl font-black text-cyan-500 drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]" id="score-p2">0</div>
            <div class="text-xs text-gray-400 mt-2">ì´ë™: ë°©í–¥í‚¤ | ìŠ¤ìœ™: <span class="text-white font-bold">Enter (ì°¨ì§€)</span></div>
          </div>
        </div>
      </div>
      
      <!-- ê²Œì„ ìº”ë²„ìŠ¤ -->
      <div class="relative bg-gray-900 rounded-2xl p-2 shadow-2xl border border-white/5">
        <canvas id="canvas" width="800" height="600" class="w-full rounded-xl bg-[#12121a] cursor-none shadow-inner"></canvas>
        
        <!-- ì˜¤ë²„ë ˆì´ -->
        <div id="overlay" class="absolute inset-0 flex items-center justify-center bg-black/85 rounded-2xl z-10 backdrop-blur-sm">
          <div class="text-center p-8">
            <div id="winner-screen" style="display:none;" class="mb-6">
              <div class="text-6xl mb-2">ğŸ†</div>
              <div id="winner-text" class="text-4xl font-black mb-2 text-white"></div>
              <div id="final-score" class="text-2xl text-gray-400 font-mono"></div>
            </div>
            <div id="start-screen">
              <h1 class="text-5xl font-black text-white mb-2 italic tracking-tighter">STICK SMASH HOCKEY</h1>
              <p class="text-gray-400 mb-8 font-light">ê¸°ë¥¼ ëª¨ì•„ ì „ë°©ìœ¼ë¡œ ê°•ë ¥í•œ ìŠ¤ë§¤ì‹œ!</p>
            </div>
            <button id="start-btn" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 px-10 py-4 rounded-full font-bold text-xl text-white shadow-lg border border-white/20 transition-transform active:scale-95">GAME START</button>
            <button id="reset-btn" style="display:none;" class="bg-gray-700 hover:bg-gray-600 px-8 py-3 rounded-full font-bold text-white mt-4">ë©”ì¸ìœ¼ë¡œ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // ì„¤ì • ê°’
    const CONFIG = {
      width: 800,
      height: 600,
      puckR: 20,
      playerR: 35,
      goalWidth: 220,
      baseSpeed: 5.5,
      dashSpeed: 12,
      maxCharge: 60,
      swingDuration: 8,
      swingArc: Math.PI / 1.5,
      stickLengthBase: 60,
      stickLengthMax: 100,
      swingPowerBase: 15,
      swingPowerMax: 35,
      boostSeconds: 15, // ë¶€ìŠ¤íŠ¸ ë°œë™ ì‹œê°„ (ì´ˆ)
    };

    // ë¶€ìŠ¤íŠ¸ í”„ë ˆì„ ê³„ì‚° (ì´ˆ * 60fps)
    const BOOST_FRAMES = CONFIG.boostSeconds * 60;

    const state = {
      puck: {x:400, y:300, vx:0, vy:0, r:CONFIG.puckR},
      p1: {
        x:100, y:300, r:CONFIG.playerR, 
        cd:0, dash:false, lk:null, lt:0,
        charging: false, chargeVal: 0, swinging: false, swingProgress: 0
      },
      p2: {
        x:700, y:300, r:CONFIG.playerR, 
        cd:0, dash:false, lk:null, lt:0,
        charging: false, chargeVal: 0, swinging: false, swingProgress: 0
      },
      keys: {}, 
      scores: {p1:0, p2:0}, 
      started:false, winner:null, paused:true, countdown:0,
      noScoreTimer: 0, speedBoostActive: false
    };

    let anim;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type, intensity = 1) {
      if(audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;

      if (type === 'hit') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
        gain.gain.setValueAtTime(Math.min(0.4, intensity/40), now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
      } else if (type === 'swing') {
        const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.1, audioCtx.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < noiseBuffer.length; i++) output[i] = Math.random() * 2 - 1;
        const src = audioCtx.createBufferSource();
        src.buffer = noiseBuffer;
        const noiseFilter = audioCtx.createBiquadFilter();
        noiseFilter.type = 'lowpass';
        noiseFilter.frequency.value = 400 + intensity * 10;
        src.connect(noiseFilter);
        noiseFilter.connect(gain);
        gain.gain.setValueAtTime(0.5, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        src.start(now);
      } else if (type === 'goal') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(300, now);
        osc.frequency.linearRampToValueAtTime(600, now + 0.5);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.8);
        osc.start(now);
        osc.stop(now + 0.8);
      } else if (type === 'wall') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(150, now);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
        osc.start(now);
        osc.stop(now + 0.05);
      }
    }

    window.onkeydown = e => {
      const k = e.key.toLowerCase();
      if(['arrowup','arrowdown','arrowleft','arrowright',' ','enter','e'].includes(k)) e.preventDefault();
      if (state.keys[k]) return;

      if (k === 'e' && !state.p1.swinging) state.p1.charging = true;
      if (k === 'enter' && !state.p2.swinging) state.p2.charging = true;

      const now = Date.now();
      if (['w','a','s','d'].includes(k)) {
        if (state.p1.lk === k && now - state.p1.lt < 250 && state.p1.cd === 0) {
          state.p1.dash = true; state.p1.cd = 60; state.p1.dir = k;
        }
        state.p1.lk = k; state.p1.lt = now;
      }
      if (['arrowup','arrowdown','arrowleft','arrowright'].includes(k)) {
        if (state.p2.lk === k && now - state.p2.lt < 250 && state.p2.cd === 0) {
          state.p2.dash = true; state.p2.cd = 60; state.p2.dir = k;
        }
        state.p2.lk = k; state.p2.lt = now;
      }
      state.keys[k] = true;
    };

    window.onkeyup = e => {
      const k = e.key.toLowerCase();
      state.keys[k] = false;
      if (k === 'e' && state.p1.charging) releaseSwing(state.p1);
      if (k === 'enter' && state.p2.charging) releaseSwing(state.p2);
    };

    function releaseSwing(p) {
      p.charging = false;
      p.swinging = true;
      p.swingProgress = 0;
      playSound('swing', p.chargeVal);
    }

    function loop() {
      if (state.paused) {
        state.countdown--;
        if (state.countdown <= 0) state.paused = false;
        draw();
        updateTimer();
        if (state.started) anim = requestAnimationFrame(loop);
        return;
      }

      updateTimer();
      state.noScoreTimer++;
      
      // â˜… ë³€ê²½ì : íƒ€ì´ë¨¸ í”„ë ˆì„(BOOST_FRAMES)ì— ì •í™•íˆ ë§ì¶¤
      if (state.noScoreTimer >= BOOST_FRAMES && !state.speedBoostActive) {
        state.speedBoostActive = true;
      }

      updatePlayer(state.p1, 'p1');
      updatePlayer(state.p2, 'p2');
      updatePhysics();
      
      checkCollision(state.p1);
      checkCollision(state.p2);
      checkSwingCollision(state.p1, 'p1');
      checkSwingCollision(state.p2, 'p2');

      draw();
      if (state.started) anim = requestAnimationFrame(loop);
    }

    function updatePlayer(p, id) {
      if (p.cd > 0) p.cd--;
      if (p.dash) {
        p.ddur = (p.ddur || 10) - 1;
        if (p.ddur <= 0) { p.dash = false; p.ddur = 10; }
      }

      if (p.charging) p.chargeVal = Math.min(p.chargeVal + 1, CONFIG.maxCharge);
      else if (!p.swinging) p.chargeVal = Math.max(0, p.chargeVal - 5);

      if (p.swinging) {
        p.swingProgress += 1 / CONFIG.swingDuration;
        if (p.swingProgress >= 1) {
          p.swinging = false;
          p.swingProgress = 0;
          p.chargeVal = 0;
        }
      }

      let spd = (p.dash ? CONFIG.dashSpeed : CONFIG.baseSpeed) * (state.speedBoostActive ? 1.2 : 1);
      if (p.charging) spd *= 0.8;
      if (p.swinging) spd *= 0.2;

      let mx = 0, my = 0;
      if (id === 'p1') {
        if (state.keys.w) my--; if (state.keys.s) my++;
        if (state.keys.a) mx--; if (state.keys.d) mx++;
      } else {
        if (state.keys.arrowup) my--; if (state.keys.arrowdown) my++;
        if (state.keys.arrowleft) mx--; if (state.keys.arrowright) mx++;
      }
      
      if (mx && my) { mx *= 0.707; my *= 0.707; }
      p.x += mx * spd;
      p.y += my * spd;

      const limitX = id === 'p1' ? CONFIG.width/2 : CONFIG.width;
      const minX = id === 'p1' ? 0 : CONFIG.width/2;
      p.x = Math.max(minX + p.r, Math.min(limitX - p.r, p.x));
      p.y = Math.max(p.r, Math.min(CONFIG.height - p.r, p.y));
    }

    function updatePhysics() {
      state.puck.x += state.puck.vx;
      state.puck.y += state.puck.vy;
      state.puck.vx *= 0.985;
      state.puck.vy *= 0.985;

      if (state.puck.y - state.puck.r < 0) {
        state.puck.y = state.puck.r; state.puck.vy *= -0.9; playSound('wall');
      }
      if (state.puck.y + state.puck.r > CONFIG.height) {
        state.puck.y = CONFIG.height - state.puck.r; state.puck.vy *= -0.9; playSound('wall');
      }

      const gt = (CONFIG.height - CONFIG.goalWidth)/2;
      const gb = gt + CONFIG.goalWidth;

      if (state.puck.x - state.puck.r < 0) {
        if (state.puck.y > gt && state.puck.y < gb) score('p2');
        else { state.puck.x = state.puck.r; state.puck.vx *= -0.9; playSound('wall'); }
      }
      if (state.puck.x + state.puck.r > CONFIG.width) {
        if (state.puck.y > gt && state.puck.y < gb) score('p1');
        else { state.puck.x = CONFIG.width - state.puck.r; state.puck.vx *= -0.9; playSound('wall'); }
      }
    }

    function checkCollision(p) {
      const dx = state.puck.x - p.x;
      const dy = state.puck.y - p.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      const minDist = state.puck.r + p.r;
      if (dist < minDist) {
        const angle = Math.atan2(dy, dx);
        const overlap = minDist - dist;
        state.puck.x += Math.cos(angle) * overlap;
        state.puck.y += Math.sin(angle) * overlap;
        const force = p.dash ? 15 : 8;
        state.puck.vx = Math.cos(angle) * force;
        state.puck.vy = Math.sin(angle) * force;
        playSound('wall', force*2);
      }
    }

    function checkSwingCollision(p, id) {
      if (!p.swinging) return;
      if (p.swingProgress < 0.2 || p.swingProgress > 0.8) return;

      const power = CONFIG.swingPowerBase + (CONFIG.swingPowerMax - CONFIG.swingPowerBase) * 0.8; 
      const reach = CONFIG.stickLengthBase + (CONFIG.stickLengthMax - CONFIG.stickLengthBase) * 0.8;

      const dx = state.puck.x - p.x;
      const dy = state.puck.y - p.y;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if (dist > reach + state.puck.r || dist < p.r) return;

      const angleToPuck = Math.atan2(dy, dx);
      const baseAngle = id === 'p1' ? 0 : Math.PI;
      
      let angleDiff = angleToPuck - baseAngle;
      while (angleDiff <= -Math.PI) angleDiff += Math.PI*2;
      while (angleDiff > Math.PI) angleDiff -= Math.PI*2;

      if (Math.abs(angleDiff) < CONFIG.swingArc / 2) {
        const hitAngle = baseAngle + angleDiff * 0.5; 
        state.puck.vx = Math.cos(hitAngle) * power;
        state.puck.vy = Math.sin(hitAngle) * power;
        state.puck.x += Math.cos(hitAngle) * 10;
        state.puck.y += Math.sin(hitAngle) * 10;
        playSound('hit', power * 3);
      }
    }

    function score(winner) {
      state.scores[winner]++;
      document.getElementById('score-p1').textContent = state.scores.p1;
      document.getElementById('score-p2').textContent = state.scores.p2;
      playSound('goal');
      if (state.scores[winner] >= 5) endGame(winner);
      else resetRound(winner);
    }

    function resetRound(scorer) {
      state.noScoreTimer = 0; state.speedBoostActive = false;
      state.p1.x = 100; state.p1.y = 300; state.p1.charging=false; state.p1.swinging=false;
      state.p2.x = 700; state.p2.y = 300; state.p2.charging=false; state.p2.swinging=false;
      state.puck.x = CONFIG.width / 2;
      state.puck.y = CONFIG.height / 2;
      state.puck.vx = 0;
      state.puck.vy = 0;
      state.paused = true; state.countdown = 60;
    }

    function endGame(winner) {
      state.started = false;
      document.getElementById('overlay').style.display = 'flex';
      document.getElementById('start-screen').style.display = 'none';
      document.getElementById('winner-screen').style.display = 'block';
      document.getElementById('reset-btn').style.display = 'inline-block';
      const wText = document.getElementById('winner-text');
      wText.textContent = winner === 'p1' ? 'PLAYER 1 WINS' : 'PLAYER 2 WINS';
      wText.className = winner === 'p1' ? 'text-5xl font-black mb-4 text-red-500' : 'text-5xl font-black mb-4 text-cyan-500';
      document.getElementById('final-score').textContent = `${state.scores.p1} - ${state.scores.p2}`;
      document.getElementById('start-btn').textContent = "REMATCH";
    }

    function draw() {
      ctx.fillStyle = '#12121a';
      ctx.fillRect(0, 0, CONFIG.width, CONFIG.height);
      
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(CONFIG.width/2, 0); ctx.lineTo(CONFIG.width/2, CONFIG.height); ctx.stroke();
      ctx.beginPath(); ctx.arc(CONFIG.width/2, CONFIG.height/2, 80, 0, Math.PI*2); ctx.stroke();

      const gt = (CONFIG.height - CONFIG.goalWidth)/2;
      ctx.fillStyle = '#ef4444'; ctx.fillRect(0, gt, 6, CONFIG.goalWidth);
      ctx.fillStyle = '#06b6d4'; ctx.fillRect(CONFIG.width-6, gt, 6, CONFIG.goalWidth);

      drawPlayer(state.p1, 'p1');
      drawPlayer(state.p2, 'p2');

      const ps = Math.sqrt(state.puck.vx**2 + state.puck.vy**2);
      ctx.fillStyle = '#fff';
      ctx.shadowBlur = ps > 10 ? 20 : 5;
      ctx.shadowColor = state.speedBoostActive ? '#f0f' : '#fff';
      ctx.beginPath(); ctx.arc(state.puck.x, state.puck.y, state.puck.r, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;

      if (state.paused && state.countdown > 0) {
        ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,CONFIG.width, CONFIG.height);
        ctx.fillStyle = '#fff'; ctx.font = '900 80px sans-serif';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(Math.ceil(state.countdown/60), CONFIG.width/2, CONFIG.height/2);
      }
    }

    function drawPlayer(p, id) {
      const color = id === 'p1' ? '#ef4444' : '#06b6d4';
      const baseAngle = id === 'p1' ? 0 : Math.PI;
      const chargeRatio = p.chargeVal / CONFIG.maxCharge;
      const stickLen = CONFIG.stickLengthBase + (CONFIG.stickLengthMax - CONFIG.stickLengthBase) * chargeRatio;
      
      let stickAngleOffset = 0;
      if (p.swinging) {
        const start = -CONFIG.swingArc / 2;
        const end = CONFIG.swingArc / 2;
        stickAngleOffset = start + (end - start) * p.swingProgress;
      } else if (p.charging) {
        stickAngleOffset = -CONFIG.swingArc / 2 * (Math.min(p.chargeVal, 20) / 20); 
        if (p.chargeVal > 40) stickAngleOffset += (Math.random()-0.5) * 0.1;
      } else {
        stickAngleOffset = -0.2; 
      }
      const currentAngle = baseAngle + stickAngleOffset;

      if (p.swinging) {
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        ctx.arc(p.x, p.y, stickLen, baseAngle - CONFIG.swingArc/2, baseAngle + CONFIG.swingArc/2, false);
        ctx.fillStyle = `rgba(255, 255, 255, ${0.3 * (1-p.swingProgress)})`;
        ctx.fill();
      }

      const stickX = p.x + Math.cos(currentAngle) * stickLen;
      const stickY = p.y + Math.sin(currentAngle) * stickLen;
      
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 6;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
      ctx.lineTo(stickX, stickY);
      ctx.stroke();

      ctx.fillStyle = color;
      ctx.shadowBlur = p.dash ? 20 : 10; ctx.shadowColor = color;
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
      
      ctx.fillStyle = 'rgba(0,0,0,0.3)';
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r*0.5, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;

      // [ìœ„ìª½] ì°¨ì§€ ê²Œì´ì§€
      if (p.charging) {
        ctx.fillStyle = '#fbbf24';
        ctx.fillRect(p.x - 20, p.y - 55, 40 * chargeRatio, 6);
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1;
        ctx.strokeRect(p.x - 20, p.y - 55, 40, 6);
      }

      // [ì•„ë˜ìª½] ëŒ€ì‹œ ì¿¨íƒ€ì„ ë°” (ê°œì„ ë¨)
      if (p.cd > 0) {
        const cdRatio = p.cd / 60; 
        
        // ë°°ê²½ (ì˜ ë³´ì´ë„ë¡ ì§„í•œ ìƒ‰)
        ctx.fillStyle = '#222';
        ctx.fillRect(p.x - 25, p.y + 50, 50, 8);

        // ê²Œì´ì§€ (ë°ì€ í˜•ê´‘ìƒ‰) - ì‹œê°„ì´ ê°ˆìˆ˜ë¡ ì¤„ì–´ë“¦
        ctx.fillStyle = '#00ffff'; 
        ctx.fillRect(p.x - 25, p.y + 50, 50 * cdRatio, 8);
        
        // í…Œë‘ë¦¬
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1;
        ctx.strokeRect(p.x - 25, p.y + 50, 50, 8);
      }
    }

    // â˜… ë³€ê²½ì : íƒ€ì´ë¨¸ ê³„ì‚° ë¡œì§ ìˆ˜ì • (Thresholdì™€ ì¼ì¹˜)
    function updateTimer() {
      // BOOST_FRAMESì—ì„œ í˜„ì¬ í”„ë ˆì„ì„ ëº€ ê°’ì„ ì´ˆ ë‹¨ìœ„ë¡œ í™˜ì‚°
      const remainingFrames = Math.max(0, BOOST_FRAMES - state.noScoreTimer);
      const remainingSeconds = Math.ceil(remainingFrames / 60);

      const el = document.getElementById('timer');
      if (state.speedBoostActive) {
        el.textContent = "BOOST!";
        el.className = "text-yellow-400 text-4xl font-black animate-pulse drop-shadow-xl";
      } else {
        el.textContent = remainingSeconds;
        // 5ì´ˆ ì´í•˜ì¼ ë•Œ ë¹¨ê°„ìƒ‰ ê²½ê³ 
        el.className = remainingSeconds <= 5 
          ? "text-red-500 text-6xl font-black animate-ping" 
          : "text-white text-5xl font-black font-mono drop-shadow-lg";
      }
    }

    document.getElementById('start-btn').onclick = () => {
      document.getElementById('overlay').style.display = 'none';
      state.scores = {p1:0, p2:0};
      resetRound();
      state.started = true;
      if (!anim) loop();
    };
    document.getElementById('reset-btn').onclick = () => {
      document.getElementById('winner-screen').style.display = 'none';
      document.getElementById('start-screen').style.display = 'block';
      document.getElementById('start-btn').textContent = "GAME START";
      document.getElementById('reset-btn').style.display = 'none';
    };

    draw();
  </script>
</body>
</html>